{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///D:/Projects/GAIA_AI_PROJECT/app/api/simulate/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport { GoogleGenerativeAI } from \"@google/generative-ai\";\r\nimport { createClient } from \"@supabase/supabase-js\";\r\n\r\nconst genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY!);\r\nconst model = genAI.getGenerativeModel({ model: \"gemini-2.5-flash\" });\r\n\r\nconst supabase = createClient(\r\n  process.env.SUPABASE_URL!,\r\n  process.env.SUPABASE_ANON!\r\n);\r\n\r\n// Extract JSON from Gemini mixed response\r\nfunction extractJson(text: string) {\r\n  const match = text.match(/\\{[\\s\\S]*\\}/);\r\n  if (!match) return null;\r\n  try { return JSON.parse(match[0]); }\r\n  catch { return null; }\r\n}\r\n\r\nexport async function POST(req: Request) {\r\n  try {\r\n    const body = await req.json();\r\n    const inputs = body.inputs;\r\n\r\n    if (!inputs) {\r\n      return NextResponse.json(\r\n        { error: \"Missing simulation inputs\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Load symbiosphere data\r\n    const { data: symbio } = await supabase\r\n      .from(\"symbiosphere_reports\")\r\n      .select(\"ai_json, level, category, created_at\")\r\n      .order(\"id\", { ascending: false })\r\n      .limit(10);\r\n\r\n    // Load global GAIA state\r\n    const { data: gaiaCache } = await supabase\r\n      .from(\"gaia_state_cache\")\r\n      .select(\"*\")\r\n      .eq(\"id\", 1)\r\n      .maybeSingle();\r\n\r\n    const prompt = `\r\nYou are GAIA 2.0 â€” the planetary-scale intelligence.\r\n\r\nA new simulation request has arrived. You must produce:\r\n\r\n1. A full environmental prediction\r\n2. A clean JSON block with environmental metrics\r\n3. High-level insights\r\n4. Recommended interventions\r\n\r\n--- USER INPUTS (SLIDERS) ---\r\n${JSON.stringify(inputs, null, 2)}\r\n\r\n--- RECENT SYMBIOSPHERE (LATEST 10) ---\r\n${JSON.stringify(symbio || [], null, 2)}\r\n\r\n--- GLOBAL GAIA STATE ---\r\n${JSON.stringify(gaiaCache || {}, null, 2)}\r\n\r\nUse real climate logic â€” increased COâ‚‚ raises Î”T, deforestation affects biodiversity, etc.\r\n\r\nRespond like:\r\n\r\nANALYSIS:\r\n<free-form detailed GAIA reasoning>\r\n\r\nJSON:\r\n{\r\n  \"symbiosis_index\": Number(0-100),\r\n  \"temperature_rise_celsius\": Number,\r\n  \"biodiversity_score\": Number(0-100),\r\n  \"sea_level_rise_meters\": Number,\r\n  \"pollution_index\": Number(0-100),\r\n\r\n  \"future_tint_hex\": \"#rrggbb\",\r\n  \"risk_index\": Number(0-1),\r\n\r\n  \"interventions_effect\": {\r\n    \"airweaver\": Number,\r\n    \"algae\": Number,\r\n    \"cryo\": Number,\r\n    \"biosynth\": Number,\r\n    \"reforest\": Number,\r\n    \"ccapture\": Number,\r\n    \"transport\": Number,\r\n    \"urbangreen\": Number\r\n  },\r\n\r\n  \"recommended_actions\": [\r\n    \"string\",\r\n    \"string\"\r\n  ],\r\n\r\n  \"summary\": \"short readable summary\"\r\n}\r\n`;\r\n\r\n    const result = await model.generateContent(prompt);\r\n    const text = result.response.text();\r\n    const json = extractJson(text);\r\n\r\n    if (!json) {\r\n      return NextResponse.json(\r\n        { error: \"Gemini did not return valid JSON\", raw: text },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    // Save scenario to Supabase\r\n    const { data: inserted } = await supabase\r\n      .from(\"scenarios\")\r\n      .insert([\r\n        {\r\n          inputs_json: inputs,\r\n          result_json: json,\r\n          ai_analysis: text.slice(0, 8000)\r\n        }\r\n      ])\r\n      .select()\r\n      .single();\r\n\r\n    // Update GAIA global state\r\n    await supabase\r\n      .from(\"gaia_state_cache\")\r\n      .upsert(\r\n        {\r\n          id: 1,\r\n          last_scenario_id: inserted?.id ?? null,\r\n          merged_state: json,\r\n          ai_summary: json.summary,\r\n          earth_tint: json.future_tint_hex,\r\n          risk_val: json.risk_index,\r\n          updated_at: new Date().toISOString()\r\n        },\r\n        { onConflict: \"id\" }\r\n      );\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      analysis: text,\r\n      result: json,\r\n      scenario_id: inserted?.id ?? null\r\n    });\r\n\r\n  } catch (err: any) {\r\n    console.error(\"ðŸ”¥ SIMULATE API error:\", err);\r\n    return NextResponse.json({ error: err.message }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAEA,MAAM,QAAQ,IAAI,sLAAkB,CAAC,QAAQ,GAAG,CAAC,cAAc;AAC/D,MAAM,QAAQ,MAAM,kBAAkB,CAAC;IAAE,OAAO;AAAmB;AAEnE,MAAM,WAAW,IAAA,yMAAY,EAC3B,QAAQ,GAAG,CAAC,YAAY,EACxB,QAAQ,GAAG,CAAC,aAAa;AAG3B,0CAA0C;AAC1C,SAAS,YAAY,IAAY;IAC/B,MAAM,QAAQ,KAAK,KAAK,CAAC;IACzB,IAAI,CAAC,OAAO,OAAO;IACnB,IAAI;QAAE,OAAO,KAAK,KAAK,CAAC,KAAK,CAAC,EAAE;IAAG,EACnC,OAAM;QAAE,OAAO;IAAM;AACvB;AAEO,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,MAAM,OAAO,MAAM,IAAI,IAAI;QAC3B,MAAM,SAAS,KAAK,MAAM;QAE1B,IAAI,CAAC,QAAQ;YACX,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA4B,GACrC;gBAAE,QAAQ;YAAI;QAElB;QAEA,yBAAyB;QACzB,MAAM,EAAE,MAAM,MAAM,EAAE,GAAG,MAAM,SAC5B,IAAI,CAAC,wBACL,MAAM,CAAC,wCACP,KAAK,CAAC,MAAM;YAAE,WAAW;QAAM,GAC/B,KAAK,CAAC;QAET,yBAAyB;QACzB,MAAM,EAAE,MAAM,SAAS,EAAE,GAAG,MAAM,SAC/B,IAAI,CAAC,oBACL,MAAM,CAAC,KACP,EAAE,CAAC,MAAM,GACT,WAAW;QAEd,MAAM,SAAS,CAAC;;;;;;;;;;;AAWpB,EAAE,KAAK,SAAS,CAAC,QAAQ,MAAM,GAAG;;;AAGlC,EAAE,KAAK,SAAS,CAAC,UAAU,EAAE,EAAE,MAAM,GAAG;;;AAGxC,EAAE,KAAK,SAAS,CAAC,aAAa,CAAC,GAAG,MAAM,GAAG;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAsC3C,CAAC;QAEG,MAAM,SAAS,MAAM,MAAM,eAAe,CAAC;QAC3C,MAAM,OAAO,OAAO,QAAQ,CAAC,IAAI;QACjC,MAAM,OAAO,YAAY;QAEzB,IAAI,CAAC,MAAM;YACT,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;gBAAoC,KAAK;YAAK,GACvD;gBAAE,QAAQ;YAAI;QAElB;QAEA,4BAA4B;QAC5B,MAAM,EAAE,MAAM,QAAQ,EAAE,GAAG,MAAM,SAC9B,IAAI,CAAC,aACL,MAAM,CAAC;YACN;gBACE,aAAa;gBACb,aAAa;gBACb,aAAa,KAAK,KAAK,CAAC,GAAG;YAC7B;SACD,EACA,MAAM,GACN,MAAM;QAET,2BAA2B;QAC3B,MAAM,SACH,IAAI,CAAC,oBACL,MAAM,CACL;YACE,IAAI;YACJ,kBAAkB,UAAU,MAAM;YAClC,cAAc;YACd,YAAY,KAAK,OAAO;YACxB,YAAY,KAAK,eAAe;YAChC,UAAU,KAAK,UAAU;YACzB,YAAY,IAAI,OAAO,WAAW;QACpC,GACA;YAAE,YAAY;QAAK;QAGvB,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,UAAU;YACV,QAAQ;YACR,aAAa,UAAU,MAAM;QAC/B;IAEF,EAAE,OAAO,KAAU;QACjB,QAAQ,KAAK,CAAC,0BAA0B;QACxC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO,IAAI,OAAO;QAAC,GAAG;YAAE,QAAQ;QAAI;IACjE;AACF","debugId":null}}]
}