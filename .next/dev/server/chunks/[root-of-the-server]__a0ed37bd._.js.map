{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///D:/Projects/GAIA_AI_PROJECT/app/api/suggest/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport { GoogleGenerativeAI } from \"@google/generative-ai\";\r\nimport { createClient } from \"@supabase/supabase-js\";\r\n\r\n// GEMINI\r\nconst genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY!);\r\nconst model = genAI.getGenerativeModel({ model: \"gemini-2.0-flash-lite\" });\r\n\r\n// SUPABASE\r\nconst supabase = createClient(\r\n  process.env.SUPABASE_URL!,\r\n  process.env.SUPABASE_ANON!\r\n);\r\n\r\n// Extract JSON even when Gemini mixes text + JSON\r\nfunction extractJson(text: string) {\r\n  const match = text.match(/\\{[\\s\\S]*\\}/);\r\n  if (!match) return null;\r\n  try {\r\n    return JSON.parse(match[0]);\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\nexport async function POST(req: Request) {\r\n  try {\r\n    const body = await req.json();\r\n    const currentInputs = body.inputs;\r\n\r\n    // Load last 10 symbiosphere logs\r\n    const { data: reports } = await supabase\r\n      .from(\"symbiosphere_reports\")\r\n      .select(\"*\")\r\n      .order(\"created_at\", { ascending: false })\r\n      .limit(10);\r\n\r\n    const { data: lastScenario } = await supabase\r\n      .from(\"scenarios\")\r\n      .select(\"result_json\")\r\n      .order(\"id\", { ascending: false })\r\n      .limit(1)\r\n      .maybeSingle();\r\n\r\n    const prompt = `\r\nYou are **GAIA 2.0**, planetary-scale cognitive system.\r\n\r\nGoal: Generate an **improved environmental scenario** based on:\r\n\r\n1. Current slider inputs  \r\n2. Recent symbiosphere reports  \r\n3. Last predicted scenario (if exists)\r\n\r\n--- CURRENT INPUTS ---\r\n${JSON.stringify(currentInputs, null, 2)}\r\n\r\n--- SYMBIOSPHERE REPORTS (latest 10) ---\r\n${JSON.stringify(reports || [], null, 2)}\r\n\r\n--- LAST PREDICTION ---\r\n${JSON.stringify(lastScenario || {}, null, 2)}\r\n\r\nOutput a refined scenario that maximizes the Symbiosis Index using realistic environmental tradeoffs.\r\n\r\nRespond with:\r\n\r\nANALYSIS:\r\n<free GAIA-style reasoning>\r\n\r\nJSON:\r\n{\r\n  \"co2\": Number(0-100),\r\n  \"def\": Number(0-100),\r\n  \"ren\": Number(0-100),\r\n  \"pol\": Number(0-100),\r\n  \"pop\": Number(-20 to 80),\r\n\r\n  \"airweaver\": Boolean,\r\n  \"airweaver_int\": Number(0-100),\r\n\r\n  \"algae\": Boolean,\r\n  \"algae_int\": Number(0-100),\r\n\r\n  \"cryo\": Boolean,\r\n  \"cryo_int\": Number(0-100),\r\n\r\n  \"biosynth\": Boolean,\r\n  \"biosynth_int\": Number(0-100),\r\n\r\n  \"reforest\": Boolean,\r\n  \"reforest_int\": Number(0-100),\r\n\r\n  \"ccapture\": Boolean,\r\n  \"ccapture_int\": Number(0-100),\r\n\r\n  \"transport\": Boolean,\r\n  \"transport_int\": Number(0-100),\r\n\r\n  \"urbangreen\": Boolean,\r\n  \"urbangreen_int\": Number(0-100)\r\n}\r\n`;\r\n\r\n    const result = await model.generateContent(prompt);\r\n    const text = result.response.text();\r\n\r\n    const json = extractJson(text);\r\n\r\n    if (!json) {\r\n      return NextResponse.json(\r\n        { error: \"Could not extract JSON\", raw: text },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    // Save to Supabase\r\n    const { data: saveData } = await supabase\r\n      .from(\"ai_suggestions\")\r\n      .insert([\r\n        {\r\n          inputs_json: currentInputs,\r\n          suggestion_json: json,\r\n          full_text: text.slice(0, 8000)\r\n        }\r\n      ])\r\n      .select()\r\n      .single();\r\n\r\n    return NextResponse.json({\r\n      analysis: text,\r\n      suggestion: json,\r\n      id: saveData?.id ?? null\r\n    });\r\n  } catch (err: any) {\r\n    console.error(\"ðŸ”¥ Suggest API error:\", err);\r\n    return NextResponse.json({ error: err.message }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAEA,SAAS;AACT,MAAM,QAAQ,IAAI,sLAAkB,CAAC,QAAQ,GAAG,CAAC,cAAc;AAC/D,MAAM,QAAQ,MAAM,kBAAkB,CAAC;IAAE,OAAO;AAAwB;AAExE,WAAW;AACX,MAAM,WAAW,IAAA,yMAAY,EAC3B,QAAQ,GAAG,CAAC,YAAY,EACxB,QAAQ,GAAG,CAAC,aAAa;AAG3B,kDAAkD;AAClD,SAAS,YAAY,IAAY;IAC/B,MAAM,QAAQ,KAAK,KAAK,CAAC;IACzB,IAAI,CAAC,OAAO,OAAO;IACnB,IAAI;QACF,OAAO,KAAK,KAAK,CAAC,KAAK,CAAC,EAAE;IAC5B,EAAE,OAAM;QACN,OAAO;IACT;AACF;AAEO,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,MAAM,OAAO,MAAM,IAAI,IAAI;QAC3B,MAAM,gBAAgB,KAAK,MAAM;QAEjC,iCAAiC;QACjC,MAAM,EAAE,MAAM,OAAO,EAAE,GAAG,MAAM,SAC7B,IAAI,CAAC,wBACL,MAAM,CAAC,KACP,KAAK,CAAC,cAAc;YAAE,WAAW;QAAM,GACvC,KAAK,CAAC;QAET,MAAM,EAAE,MAAM,YAAY,EAAE,GAAG,MAAM,SAClC,IAAI,CAAC,aACL,MAAM,CAAC,eACP,KAAK,CAAC,MAAM;YAAE,WAAW;QAAM,GAC/B,KAAK,CAAC,GACN,WAAW;QAEd,MAAM,SAAS,CAAC;;;;;;;;;;AAUpB,EAAE,KAAK,SAAS,CAAC,eAAe,MAAM,GAAG;;;AAGzC,EAAE,KAAK,SAAS,CAAC,WAAW,EAAE,EAAE,MAAM,GAAG;;;AAGzC,EAAE,KAAK,SAAS,CAAC,gBAAgB,CAAC,GAAG,MAAM,GAAG;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAyC9C,CAAC;QAEG,MAAM,SAAS,MAAM,MAAM,eAAe,CAAC;QAC3C,MAAM,OAAO,OAAO,QAAQ,CAAC,IAAI;QAEjC,MAAM,OAAO,YAAY;QAEzB,IAAI,CAAC,MAAM;YACT,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;gBAA0B,KAAK;YAAK,GAC7C;gBAAE,QAAQ;YAAI;QAElB;QAEA,mBAAmB;QACnB,MAAM,EAAE,MAAM,QAAQ,EAAE,GAAG,MAAM,SAC9B,IAAI,CAAC,kBACL,MAAM,CAAC;YACN;gBACE,aAAa;gBACb,iBAAiB;gBACjB,WAAW,KAAK,KAAK,CAAC,GAAG;YAC3B;SACD,EACA,MAAM,GACN,MAAM;QAET,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,UAAU;YACV,YAAY;YACZ,IAAI,UAAU,MAAM;QACtB;IACF,EAAE,OAAO,KAAU;QACjB,QAAQ,KAAK,CAAC,yBAAyB;QACvC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO,IAAI,OAAO;QAAC,GAAG;YAAE,QAAQ;QAAI;IACjE;AACF","debugId":null}}]
}