{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///D:/Projects/GAIA_AI_PROJECT/lib/geminiRetry.ts"],"sourcesContent":["import { GoogleGenerativeAI } from \"@google/generative-ai\";\r\n\r\nconst genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY!);\r\n\r\nexport const model = genAI.getGenerativeModel({ model: \"gemini-2.0-flash-lite\" });\r\n\r\nexport async function safeGemini(prompt: string) {\r\n  const MAX_RETRIES = 4;\r\n  let wait = 700;\r\n\r\n  for (let attempt = 1; attempt <= MAX_RETRIES; attempt++) {\r\n    try {\r\n      return await model.generateContent(prompt);\r\n    } catch (err: any) {\r\n      const status = err?.status || err?.statusCode || null;\r\n\r\n      // model overloaded OR rate limit\r\n      const retriable = status === 503 || status === 429;\r\n\r\n      if (attempt === MAX_RETRIES || !retriable) {\r\n        throw err;\r\n      }\r\n\r\n      console.warn(`⚠️ Gemini attempt ${attempt} failed — retrying in ${wait}ms`);\r\n      await new Promise((r) => setTimeout(r, wait));\r\n      wait *= 2; // exponential backoff\r\n    }\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;;AAEA,MAAM,QAAQ,IAAI,sLAAkB,CAAC,QAAQ,GAAG,CAAC,cAAc;AAExD,MAAM,QAAQ,MAAM,kBAAkB,CAAC;IAAE,OAAO;AAAwB;AAExE,eAAe,WAAW,MAAc;IAC7C,MAAM,cAAc;IACpB,IAAI,OAAO;IAEX,IAAK,IAAI,UAAU,GAAG,WAAW,aAAa,UAAW;QACvD,IAAI;YACF,OAAO,MAAM,MAAM,eAAe,CAAC;QACrC,EAAE,OAAO,KAAU;YACjB,MAAM,SAAS,KAAK,UAAU,KAAK,cAAc;YAEjD,iCAAiC;YACjC,MAAM,YAAY,WAAW,OAAO,WAAW;YAE/C,IAAI,YAAY,eAAe,CAAC,WAAW;gBACzC,MAAM;YACR;YAEA,QAAQ,IAAI,CAAC,CAAC,kBAAkB,EAAE,QAAQ,sBAAsB,EAAE,KAAK,EAAE,CAAC;YAC1E,MAAM,IAAI,QAAQ,CAAC,IAAM,WAAW,GAAG;YACvC,QAAQ,GAAG,sBAAsB;QACnC;IACF;AACF","debugId":null}},
    {"offset": {"line": 81, "column": 0}, "map": {"version":3,"sources":["file:///D:/Projects/GAIA_AI_PROJECT/app/api/simulate/gemini/route.ts"],"sourcesContent":["// app/api/simulate/gemini/route.ts\r\n\r\nimport { NextResponse } from \"next/server\";\r\nimport { safeGemini } from \"@/lib/geminiRetry\";\r\nimport { createClient } from \"@supabase/supabase-js\";\r\n\r\nconst supabase = createClient(\r\n  process.env.SUPABASE_URL!,\r\n  process.env.SUPABASE_ANON!\r\n);\r\n\r\nfunction extractJson(text: string) {\r\n  const match = text.match(/\\{[\\s\\S]*\\}/);\r\n  if (!match) return null;\r\n  try { return JSON.parse(match[0]); }\r\n  catch { return null; }\r\n}\r\n\r\nexport async function POST(req: Request) {\r\n  try {\r\n    const body = await req.json();\r\n    const inputs = body.inputs;\r\n\r\n    if (!inputs) {\r\n      return NextResponse.json({ error: \"Missing simulation inputs\" }, { status: 400 });\r\n    }\r\n\r\n    const prompt = `You are GAIA 2.0 — the planetary-scale intelligence.\r\n\r\nAnalyze this simulation and produce a detailed environmental prediction:\r\n\r\n--- USER INPUTS (SLIDERS) ---\r\n${JSON.stringify(inputs, null, 2)}\r\n\r\nUse real climate logic:\r\n- Higher CO₂ (>70) raises temperature significantly, decreases biodiversity, increases sea level\r\n- Higher deforestation (>60) decreases biodiversity, raises temperature\r\n- Higher renewables (>70) decreases temperature, increases biodiversity\r\n- Higher pollution control (>60) increases biodiversity\r\n- Each intervention has specific effects on the index\r\n\r\nReturn your response with an ANALYSIS section followed by a JSON block:\r\n\r\nANALYSIS:\r\n<detailed reasoning about the environmental impact>\r\n\r\nJSON:\r\n{\r\n  \"index\": Number(0-100),\r\n  \"tempDrift\": Number (in Celsius, can be negative or positive),\r\n  \"biodiversity\": Number(0-100),\r\n  \"seaLevel\": Number(in meters, usually 0-1),\r\n  \"summary\": \"one-line description\"\r\n}`;\r\n\r\n    const g = await safeGemini(prompt);\r\n    const text = await g.response.text();\r\n    const json = extractJson(text);\r\n\r\n    if (!json) {\r\n      return NextResponse.json({ error: \"Gemini did not return valid JSON\", raw: text }, { status: 500 });\r\n    }\r\n\r\n    // Ensure numeric fields are numbers\r\n    const result = {\r\n      index: parseInt(json.index) || 50,\r\n      tempDrift: parseFloat(json.tempDrift) || 0,\r\n      biodiversity: parseInt(json.biodiversity) || 50,\r\n      seaLevel: parseFloat(json.seaLevel) || 0,\r\n      summary: json.summary || \"Simulation complete\"\r\n    };\r\n    \r\n\r\nconst payloadLocation = body.city || 'Global';\r\n\r\nconst { data: inserted } = await supabase\r\n  .from(\"scenarios\")\r\n  .insert([\r\n    {\r\n      inputs_json: inputs,\r\n      result_json: result,\r\n      ai_analysis: text.slice(0, 8000),\r\n      location: payloadLocation\r\n    }\r\n  ])\r\n  .select()\r\n  .single();\r\n\r\n    // Update gaia_state_cache\r\n    await supabase\r\n      .from(\"gaia_state_cache\")\r\n      .upsert(\r\n        {\r\n          id: 1,\r\n          last_scenario_id: inserted?.id ?? null,\r\n          merged_state: result,\r\n          ai_summary: result.summary,\r\n          updated_at: new Date().toISOString()\r\n        },\r\n        { onConflict: \"id\" }\r\n      );\r\n\r\n\r\n\r\n\r\n    return NextResponse.json({ result, analysis: text });\r\n  } catch (err: any) {\r\n    console.error(\"/api/simulate/gemini error:\", err);\r\n    return NextResponse.json({ error: err?.message || String(err) }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":"AAAA,mCAAmC;;;;;AAEnC;AACA;AACA;;;;AAEA,MAAM,WAAW,IAAA,yMAAY,EAC3B,QAAQ,GAAG,CAAC,YAAY,EACxB,QAAQ,GAAG,CAAC,aAAa;AAG3B,SAAS,YAAY,IAAY;IAC/B,MAAM,QAAQ,KAAK,KAAK,CAAC;IACzB,IAAI,CAAC,OAAO,OAAO;IACnB,IAAI;QAAE,OAAO,KAAK,KAAK,CAAC,KAAK,CAAC,EAAE;IAAG,EACnC,OAAM;QAAE,OAAO;IAAM;AACvB;AAEO,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,MAAM,OAAO,MAAM,IAAI,IAAI;QAC3B,MAAM,SAAS,KAAK,MAAM;QAE1B,IAAI,CAAC,QAAQ;YACX,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA4B,GAAG;gBAAE,QAAQ;YAAI;QACjF;QAEA,MAAM,SAAS,CAAC;;;;;AAKpB,EAAE,KAAK,SAAS,CAAC,QAAQ,MAAM,GAAG;;;;;;;;;;;;;;;;;;;;;CAqBjC,CAAC;QAEE,MAAM,IAAI,MAAM,IAAA,kIAAU,EAAC;QAC3B,MAAM,OAAO,MAAM,EAAE,QAAQ,CAAC,IAAI;QAClC,MAAM,OAAO,YAAY;QAEzB,IAAI,CAAC,MAAM;YACT,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;gBAAoC,KAAK;YAAK,GAAG;gBAAE,QAAQ;YAAI;QACnG;QAEA,oCAAoC;QACpC,MAAM,SAAS;YACb,OAAO,SAAS,KAAK,KAAK,KAAK;YAC/B,WAAW,WAAW,KAAK,SAAS,KAAK;YACzC,cAAc,SAAS,KAAK,YAAY,KAAK;YAC7C,UAAU,WAAW,KAAK,QAAQ,KAAK;YACvC,SAAS,KAAK,OAAO,IAAI;QAC3B;QAGJ,MAAM,kBAAkB,KAAK,IAAI,IAAI;QAErC,MAAM,EAAE,MAAM,QAAQ,EAAE,GAAG,MAAM,SAC9B,IAAI,CAAC,aACL,MAAM,CAAC;YACN;gBACE,aAAa;gBACb,aAAa;gBACb,aAAa,KAAK,KAAK,CAAC,GAAG;gBAC3B,UAAU;YACZ;SACD,EACA,MAAM,GACN,MAAM;QAEL,0BAA0B;QAC1B,MAAM,SACH,IAAI,CAAC,oBACL,MAAM,CACL;YACE,IAAI;YACJ,kBAAkB,UAAU,MAAM;YAClC,cAAc;YACd,YAAY,OAAO,OAAO;YAC1B,YAAY,IAAI,OAAO,WAAW;QACpC,GACA;YAAE,YAAY;QAAK;QAMvB,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE;YAAQ,UAAU;QAAK;IACpD,EAAE,OAAO,KAAU;QACjB,QAAQ,KAAK,CAAC,+BAA+B;QAC7C,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO,KAAK,WAAW,OAAO;QAAK,GAAG;YAAE,QAAQ;QAAI;IACjF;AACF","debugId":null}}]
}