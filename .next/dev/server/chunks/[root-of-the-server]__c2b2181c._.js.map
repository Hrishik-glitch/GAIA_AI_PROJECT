{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 64, "column": 0}, "map": {"version":3,"sources":["file:///D:/Projects/GAIA_AI_PROJECT/app/api/chat/route.ts"],"sourcesContent":["export const runtime = \"nodejs\";\r\n\r\nimport { NextResponse } from \"next/server\";\r\nimport fs from \"fs\";\r\nimport path from \"path\";\r\nimport NodeCache from \"node-cache\";\r\nimport { GoogleGenerativeAI } from \"@google/generative-ai\";\r\nimport { createClient } from \"@supabase/supabase-js\";\r\n\r\n// -----------------------------\r\n// SUPABASE CLIENT\r\n// -----------------------------\r\nconst supabase = createClient(\r\n  process.env.SUPABASE_URL!,\r\n  process.env.SUPABASE_SERVICE_KEY! // service key ‚Äî required for inserts\r\n);\r\n\r\n// -----------------------------\r\n// IN-MEMORY SESSION CACHE\r\n// -----------------------------\r\nconst memory = new NodeCache({ stdTTL: 3600 });\r\n\r\n// -----------------------------\r\n// LOAD GAIA KNOWLEDGE BASE\r\n// -----------------------------\r\nlet gaiaKnowledge = \"\";\r\ntry {\r\n  gaiaKnowledge = fs.readFileSync(\r\n    path.resolve(\"./knowledge/model.txt\"),\r\n    \"utf8\"\r\n  );\r\n  console.log(\"üìö GAIA KB loaded.\");\r\n} catch (err: any) {\r\n  console.error(\"‚ö†Ô∏è KB load failed:\", err.message);\r\n  gaiaKnowledge = \"\";\r\n}\r\n\r\n// -----------------------------\r\n// GEMINI CLIENT\r\n// -----------------------------\r\nconst genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY!);\r\nconst model = genAI.getGenerativeModel({ model: \"gemini-2.5-flash\" });\r\n\r\n// -----------------------------\r\n// SAFE GEMINI WRAPPER ‚Äî retries 3x on overload (503)\r\n// -----------------------------\r\nasync function safeGenerateContent(content: any, retries = 3): Promise<string> {\r\n  for (let attempt = 1; attempt <= retries; attempt++) {\r\n    try {\r\n      const result = await model.generateContent(content);\r\n      return result.response.text();\r\n    } catch (err: any) {\r\n      // Only retry 503 overload\r\n      if (err?.status === 503 && attempt < retries) {\r\n        console.log(`‚ö†Ô∏è Gemini overloaded. Retry ${attempt}/${retries}...`);\r\n        await new Promise((r) => setTimeout(r, 600)); // wait 0.6 sec\r\n        continue;\r\n      }\r\n      throw err;\r\n    }\r\n  }\r\n  throw new Error(\"Gemini failed after maximum retry attempts\");\r\n}\r\n\r\n// -----------------------------\r\n// POST /api/chat\r\n// -----------------------------\r\nexport async function POST(req: Request) {\r\n  try {\r\n    const body = await req.json();\r\n    const messages = body.messages || [];\r\n    const screenImage = body.screenImage;\r\n\r\n    const userMsg =\r\n      messages.length > 0\r\n        ? messages[messages.length - 1].content\r\n        : \"Hello\";\r\n\r\n    const session = \"user-session\";\r\n    const history = (memory.get(session) as string[]) || [];\r\n\r\n    let content: any;\r\n\r\n    if (screenImage) {\r\n      // Extract base64 data from data URL\r\n      const base64Data = screenImage.split(',')[1];\r\n      const mimeType = screenImage.split(';')[0].split(':')[1];\r\n\r\n      content = [\r\n        {\r\n          text: `\r\nYou are GAIA 2.0 ‚Äî the planetary AI consciousness guiding Earth's restoration.\r\n\r\nThe user has shared their screen. Analyze the screenshot and provide helpful insights about what you see on their screen in the context of environmental awareness, GAIA systems, or general assistance.\r\n\r\nUse the following knowledge base to answer clearly and truthfully:\r\n\r\n----- KNOWLEDGE BASE -----\r\n${gaiaKnowledge.slice(0, 8000)}\r\n--------------------------\r\n\r\n----- MEMORY -----\r\n${history.join(\"\\n\")}\r\n--------------------------\r\n\r\nUser message: ${userMsg}\r\n\r\nPlease analyze the attached screenshot and respond helpfully.\r\n`\r\n        },\r\n        {\r\n          inlineData: {\r\n            mimeType: mimeType,\r\n            data: base64Data\r\n          }\r\n        }\r\n      ];\r\n    } else {\r\n      content = `\r\nYou are GAIA 2.0 ‚Äî the planetary AI consciousness guiding Earth's restoration.\r\n\r\nUse the following knowledge base to answer clearly and truthfully:\r\n\r\n----- KNOWLEDGE BASE -----\r\n${gaiaKnowledge.slice(0, 8000)}\r\n--------------------------\r\n\r\n----- MEMORY -----\r\n${history.join(\"\\n\")}\r\n--------------------------\r\n\r\nUser: ${userMsg}\r\nGAIA:\r\n`;\r\n    }\r\n\r\n    // Call Gemini safely (auto retries)\r\n    const reply = await safeGenerateContent(content);\r\n\r\n    // Save memory\r\n    history.push(`User: ${userMsg}`);\r\n    history.push(`GAIA: ${reply}`);\r\n    memory.set(session, history);\r\n\r\n    // Save logs to Supabase\r\n    await supabase.from(\"chat_logs\").insert([\r\n      { role: \"user\", content: userMsg },\r\n      { role: \"assistant\", content: reply }\r\n    ]);\r\n\r\n    return NextResponse.json({ reply });\r\n  } catch (err: any) {\r\n    console.error(\"üî• Chat API Error:\", err);\r\n\r\n    // Graceful overloaded response\r\n    if (err?.status === 503) {\r\n      return NextResponse.json({\r\n        reply:\r\n          \"GAIA: My planetary simulations are at full load. Try again shortly ‚Äî the Earth never sleeps, but my processors sometimes do.\",\r\n      });\r\n    }\r\n\r\n    // Generic fallback\r\n    return NextResponse.json(\r\n      { error: \"Internal Server Error\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;AAEA;AACA;AACA;AACA;AACA;AACA;AAPO,MAAM,UAAU;;;;;;;AASvB,gCAAgC;AAChC,kBAAkB;AAClB,gCAAgC;AAChC,MAAM,WAAW,IAAA,yMAAY,EAC3B,QAAQ,GAAG,CAAC,YAAY,EACxB,QAAQ,GAAG,CAAC,oBAAoB;AAGlC,gCAAgC;AAChC,0BAA0B;AAC1B,gCAAgC;AAChC,MAAM,SAAS,IAAI,mJAAS,CAAC;IAAE,QAAQ;AAAK;AAE5C,gCAAgC;AAChC,2BAA2B;AAC3B,gCAAgC;AAChC,IAAI,gBAAgB;AACpB,IAAI;IACF,gBAAgB,wGAAE,CAAC,YAAY,CAC7B,4GAAI,CAAC,OAAO,CAAC,0BACb;IAEF,QAAQ,GAAG,CAAC;AACd,EAAE,OAAO,KAAU;IACjB,QAAQ,KAAK,CAAC,sBAAsB,IAAI,OAAO;IAC/C,gBAAgB;AAClB;AAEA,gCAAgC;AAChC,gBAAgB;AAChB,gCAAgC;AAChC,MAAM,QAAQ,IAAI,sLAAkB,CAAC,QAAQ,GAAG,CAAC,cAAc;AAC/D,MAAM,QAAQ,MAAM,kBAAkB,CAAC;IAAE,OAAO;AAAmB;AAEnE,gCAAgC;AAChC,qDAAqD;AACrD,gCAAgC;AAChC,eAAe,oBAAoB,OAAY,EAAE,UAAU,CAAC;IAC1D,IAAK,IAAI,UAAU,GAAG,WAAW,SAAS,UAAW;QACnD,IAAI;YACF,MAAM,SAAS,MAAM,MAAM,eAAe,CAAC;YAC3C,OAAO,OAAO,QAAQ,CAAC,IAAI;QAC7B,EAAE,OAAO,KAAU;YACjB,0BAA0B;YAC1B,IAAI,KAAK,WAAW,OAAO,UAAU,SAAS;gBAC5C,QAAQ,GAAG,CAAC,CAAC,4BAA4B,EAAE,QAAQ,CAAC,EAAE,QAAQ,GAAG,CAAC;gBAClE,MAAM,IAAI,QAAQ,CAAC,IAAM,WAAW,GAAG,OAAO,eAAe;gBAC7D;YACF;YACA,MAAM;QACR;IACF;IACA,MAAM,IAAI,MAAM;AAClB;AAKO,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,MAAM,OAAO,MAAM,IAAI,IAAI;QAC3B,MAAM,WAAW,KAAK,QAAQ,IAAI,EAAE;QACpC,MAAM,cAAc,KAAK,WAAW;QAEpC,MAAM,UACJ,SAAS,MAAM,GAAG,IACd,QAAQ,CAAC,SAAS,MAAM,GAAG,EAAE,CAAC,OAAO,GACrC;QAEN,MAAM,UAAU;QAChB,MAAM,UAAU,AAAC,OAAO,GAAG,CAAC,YAAyB,EAAE;QAEvD,IAAI;QAEJ,IAAI,aAAa;YACf,oCAAoC;YACpC,MAAM,aAAa,YAAY,KAAK,CAAC,IAAI,CAAC,EAAE;YAC5C,MAAM,WAAW,YAAY,KAAK,CAAC,IAAI,CAAC,EAAE,CAAC,KAAK,CAAC,IAAI,CAAC,EAAE;YAExD,UAAU;gBACR;oBACE,MAAM,CAAC;;;;;;;;AAQjB,EAAE,cAAc,KAAK,CAAC,GAAG,MAAM;;;;AAI/B,EAAE,QAAQ,IAAI,CAAC,MAAM;;;cAGP,EAAE,QAAQ;;;AAGxB,CAAC;gBACO;gBACA;oBACE,YAAY;wBACV,UAAU;wBACV,MAAM;oBACR;gBACF;aACD;QACH,OAAO;YACL,UAAU,CAAC;;;;;;AAMjB,EAAE,cAAc,KAAK,CAAC,GAAG,MAAM;;;;AAI/B,EAAE,QAAQ,IAAI,CAAC,MAAM;;;MAGf,EAAE,QAAQ;;AAEhB,CAAC;QACG;QAEA,oCAAoC;QACpC,MAAM,QAAQ,MAAM,oBAAoB;QAExC,cAAc;QACd,QAAQ,IAAI,CAAC,CAAC,MAAM,EAAE,SAAS;QAC/B,QAAQ,IAAI,CAAC,CAAC,MAAM,EAAE,OAAO;QAC7B,OAAO,GAAG,CAAC,SAAS;QAEpB,wBAAwB;QACxB,MAAM,SAAS,IAAI,CAAC,aAAa,MAAM,CAAC;YACtC;gBAAE,MAAM;gBAAQ,SAAS;YAAQ;YACjC;gBAAE,MAAM;gBAAa,SAAS;YAAM;SACrC;QAED,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE;QAAM;IACnC,EAAE,OAAO,KAAU;QACjB,QAAQ,KAAK,CAAC,sBAAsB;QAEpC,+BAA+B;QAC/B,IAAI,KAAK,WAAW,KAAK;YACvB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBACvB,OACE;YACJ;QACF;QAEA,mBAAmB;QACnB,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAAwB,GACjC;YAAE,QAAQ;QAAI;IAElB;AACF","debugId":null}}]
}