module.exports = [
"[externals]/next/dist/compiled/next-server/app-route-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-route-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/@opentelemetry/api [external] (next/dist/compiled/@opentelemetry/api, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/@opentelemetry/api", () => require("next/dist/compiled/@opentelemetry/api"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/next-server/app-page-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-page-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-unit-async-storage.external.js [external] (next/dist/server/app-render/work-unit-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-unit-async-storage.external.js", () => require("next/dist/server/app-render/work-unit-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-async-storage.external.js [external] (next/dist/server/app-render/work-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-async-storage.external.js", () => require("next/dist/server/app-render/work-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/shared/lib/no-fallback-error.external.js [external] (next/dist/shared/lib/no-fallback-error.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/shared/lib/no-fallback-error.external.js", () => require("next/dist/shared/lib/no-fallback-error.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/after-task-async-storage.external.js [external] (next/dist/server/app-render/after-task-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/after-task-async-storage.external.js", () => require("next/dist/server/app-render/after-task-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/fs [external] (fs, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("fs", () => require("fs"));

module.exports = mod;
}),
"[externals]/path [external] (path, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("path", () => require("path"));

module.exports = mod;
}),
"[externals]/events [external] (events, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("events", () => require("events"));

module.exports = mod;
}),
"[project]/app/api/chat/route.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "POST",
    ()=>POST,
    "runtime",
    ()=>runtime
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/server.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$externals$5d2f$fs__$5b$external$5d$__$28$fs$2c$__cjs$29$__ = __turbopack_context__.i("[externals]/fs [external] (fs, cjs)");
var __TURBOPACK__imported__module__$5b$externals$5d2f$path__$5b$external$5d$__$28$path$2c$__cjs$29$__ = __turbopack_context__.i("[externals]/path [external] (path, cjs)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$node$2d$cache$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/node-cache/index.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$google$2f$generative$2d$ai$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/@google/generative-ai/dist/index.mjs [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$supabase$2f$supabase$2d$js$2f$dist$2f$module$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/node_modules/@supabase/supabase-js/dist/module/index.js [app-route] (ecmascript) <locals>");
const runtime = "nodejs";
;
;
;
;
;
;
// -----------------------------
// SUPABASE CLIENT
// -----------------------------
const supabase = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$supabase$2f$supabase$2d$js$2f$dist$2f$module$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["createClient"])(process.env.SUPABASE_URL, process.env.SUPABASE_SERVICE_KEY);
// -----------------------------
// IN-MEMORY SESSION CACHE
// -----------------------------
const memory = new __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$node$2d$cache$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"]({
    stdTTL: 3600
});
// -----------------------------
// LOAD GAIA KNOWLEDGE BASE
// -----------------------------
let gaiaKnowledge = "";
try {
    gaiaKnowledge = __TURBOPACK__imported__module__$5b$externals$5d2f$fs__$5b$external$5d$__$28$fs$2c$__cjs$29$__["default"].readFileSync(__TURBOPACK__imported__module__$5b$externals$5d2f$path__$5b$external$5d$__$28$path$2c$__cjs$29$__["default"].resolve("./knowledge/model.txt"), "utf8");
    console.log("üìö GAIA KB loaded.");
} catch (err) {
    console.error("‚ö†Ô∏è KB load failed:", err.message);
    gaiaKnowledge = "";
}
// -----------------------------
// GEMINI CLIENT
// -----------------------------
const genAI = new __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$google$2f$generative$2d$ai$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["GoogleGenerativeAI"](process.env.GEMINI_API_KEY);
const model = genAI.getGenerativeModel({
    model: "gemini-2.5-flash"
});
// -----------------------------
// SAFE GEMINI WRAPPER ‚Äî retries 3x on overload (503)
// -----------------------------
async function safeGenerateContent(content, retries = 3) {
    for(let attempt = 1; attempt <= retries; attempt++){
        try {
            const result = await model.generateContent(content);
            return result.response.text();
        } catch (err) {
            // Only retry 503 overload
            if (err?.status === 503 && attempt < retries) {
                console.log(`‚ö†Ô∏è Gemini overloaded. Retry ${attempt}/${retries}...`);
                await new Promise((r)=>setTimeout(r, 600)); // wait 0.6 sec
                continue;
            }
            throw err;
        }
    }
    throw new Error("Gemini failed after maximum retry attempts");
}
async function POST(req) {
    try {
        const body = await req.json();
        const messages = body.messages || [];
        const screenImage = body.screenImage;
        const userMsg = messages.length > 0 ? messages[messages.length - 1].content : "Hello";
        const session = "user-session";
        const history = memory.get(session) || [];
        let content;
        if (screenImage) {
            // Extract base64 data from data URL
            const base64Data = screenImage.split(',')[1];
            const mimeType = screenImage.split(';')[0].split(':')[1];
            content = [
                {
                    text: `
You are GAIA 2.0 ‚Äî the planetary AI consciousness guiding Earth's restoration.

The user has shared their screen. Analyze the screenshot and provide helpful insights about what you see on their screen in the context of environmental awareness, GAIA systems, or general assistance.

Use the following knowledge base to answer clearly and truthfully:

----- KNOWLEDGE BASE -----
${gaiaKnowledge.slice(0, 8000)}
--------------------------

----- MEMORY -----
${history.join("\n")}
--------------------------

User message: ${userMsg}

Please analyze the attached screenshot and respond helpfully.
`
                },
                {
                    inlineData: {
                        mimeType: mimeType,
                        data: base64Data
                    }
                }
            ];
        } else {
            content = `
You are GAIA 2.0 ‚Äî the planetary AI consciousness guiding Earth's restoration.

Use the following knowledge base to answer clearly and truthfully:

----- KNOWLEDGE BASE -----
${gaiaKnowledge.slice(0, 8000)}
--------------------------

----- MEMORY -----
${history.join("\n")}
--------------------------

User: ${userMsg}
GAIA:
`;
        }
        // Call Gemini safely (auto retries)
        const reply = await safeGenerateContent(content);
        // Save memory
        history.push(`User: ${userMsg}`);
        history.push(`GAIA: ${reply}`);
        memory.set(session, history);
        // Save logs to Supabase
        await supabase.from("chat_logs").insert([
            {
                role: "user",
                content: userMsg
            },
            {
                role: "assistant",
                content: reply
            }
        ]);
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            reply
        });
    } catch (err) {
        console.error("üî• Chat API Error:", err);
        // Graceful overloaded response
        if (err?.status === 503) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                reply: "GAIA: My planetary simulations are at full load. Try again shortly ‚Äî the Earth never sleeps, but my processors sometimes do."
            });
        }
        // Generic fallback
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: "Internal Server Error"
        }, {
            status: 500
        });
    }
}
}),
];

//# sourceMappingURL=%5Broot-of-the-server%5D__c2b2181c._.js.map