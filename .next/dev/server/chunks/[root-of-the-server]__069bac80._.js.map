{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///D:/Projects/GAIA_AI_PROJECT/app/api/state/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport { GoogleGenerativeAI } from \"@google/generative-ai\";\r\nimport { createClient } from \"@supabase/supabase-js\";\r\n\r\nconst genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY!);\r\nconst model = genAI.getGenerativeModel({ model: \"gemini-2.0-flash-lite\" });\r\n\r\nconst supabase = createClient(\r\n  process.env.SUPABASE_URL!,\r\n  process.env.SUPABASE_ANON!\r\n);\r\n\r\n// Extract a JSON block even if Gemini rambling surrounds it\r\nfunction extractJson(text: string) {\r\n  const match = text.match(/\\{[\\s\\S]*\\}/);\r\n  if (!match) return null;\r\n  try {\r\n    return JSON.parse(match[0]);\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\nexport async function GET() {\r\n  try {\r\n    // 1) Fetch last scenario\r\n    const { data: lastScenario } = await supabase\r\n      .from(\"scenarios\")\r\n      .select(\"result_json, inputs_json, created_at\")\r\n      .order(\"id\", { ascending: false })\r\n      .limit(1)\r\n      .maybeSingle();\r\n\r\n    // 2) Fetch latest symbiosphere batch\r\n    const { data: symbio } = await supabase\r\n      .from(\"symbiosphere_reports\")\r\n      .select(\"ai_json, level, category, created_at\")\r\n      .order(\"id\", { ascending: false })\r\n      .limit(5);\r\n\r\n    // 3) Fetch GAIA world-state cache\r\n    const { data: cache } = await supabase\r\n      .from(\"gaia_state_cache\")\r\n      .select(\"*\")\r\n      .eq(\"id\", 1)\r\n      .maybeSingle();\r\n\r\n    const prompt = `\r\nYou are GAIA 2.0, the planetary cognition engine.\r\n\r\nUsing the latest system data, produce a **unified GAIA world-state object**.\r\n\r\n--- SCENARIO ---\r\n${JSON.stringify(lastScenario?.result_json || {}, null, 2)}\r\n\r\n--- SYMBIOSPHERE (LATEST 5) ---\r\n${JSON.stringify(symbio || [], null, 2)}\r\n\r\n--- EXISTING GAIA CACHE ---\r\n${JSON.stringify(cache || {}, null, 2)}\r\n\r\nYour job: Merge these signals and produce:\r\n1. GAIA's interpretation of Earth's immediate condition.\r\n2. Nexus visual parameters.\r\n3. GAIA-Link short environmental summary.\r\n4. A global \"risk index\" (0-1).\r\n5. Color tint for predicted Earth overlay.\r\n6. A friendly short message users can read.\r\n\r\nRespond like this:\r\n\r\nANALYSIS:\r\n<free GAIA internal reasoning>\r\n\r\nJSON:\r\n{\r\n  \"risk\": Number(0-1),\r\n  \"earth_tint\": \"#aabbcc\",\r\n  \"mood\": \"Harmonic\" | \"Tense\" | \"Critical\",\r\n  \"nexus\": {\r\n    \"chaos\": Number(0-3),\r\n    \"hue\": Number(0-360)\r\n  },\r\n  \"gaia_link\": {\r\n    \"delta_temp\": Number,\r\n    \"biodiversity\": Number,\r\n    \"sea_level\": Number\r\n  },\r\n  \"summary\": \"short readable one-sentence summary\"\r\n}\r\n`;\r\n\r\n    const g = await model.generateContent(prompt);\r\n    const text = g.response.text();\r\n    const json = extractJson(text);\r\n\r\n    if (!json)\r\n      return NextResponse.json(\r\n        { error: \"Gemini returned no JSON\", raw: text },\r\n        { status: 500 }\r\n      );\r\n\r\n    // Update global cache\r\n    await supabase\r\n      .from(\"gaia_state_cache\")\r\n      .upsert(\r\n        {\r\n          id: 1,\r\n          merged_state: json,\r\n          ai_summary: json.summary,\r\n          updated_at: new Date().toISOString()\r\n        },\r\n        { onConflict: \"id\" }\r\n      );\r\n\r\n    return NextResponse.json({\r\n      state: json,\r\n      raw: text\r\n    });\r\n  } catch (err: any) {\r\n    console.error(\"ðŸ”¥ STATE API error:\", err);\r\n    return NextResponse.json({ error: err.message }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAEA,MAAM,QAAQ,IAAI,sLAAkB,CAAC,QAAQ,GAAG,CAAC,cAAc;AAC/D,MAAM,QAAQ,MAAM,kBAAkB,CAAC;IAAE,OAAO;AAAwB;AAExE,MAAM,WAAW,IAAA,yMAAY,EAC3B,QAAQ,GAAG,CAAC,YAAY,EACxB,QAAQ,GAAG,CAAC,aAAa;AAG3B,4DAA4D;AAC5D,SAAS,YAAY,IAAY;IAC/B,MAAM,QAAQ,KAAK,KAAK,CAAC;IACzB,IAAI,CAAC,OAAO,OAAO;IACnB,IAAI;QACF,OAAO,KAAK,KAAK,CAAC,KAAK,CAAC,EAAE;IAC5B,EAAE,OAAM;QACN,OAAO;IACT;AACF;AAEO,eAAe;IACpB,IAAI;QACF,yBAAyB;QACzB,MAAM,EAAE,MAAM,YAAY,EAAE,GAAG,MAAM,SAClC,IAAI,CAAC,aACL,MAAM,CAAC,wCACP,KAAK,CAAC,MAAM;YAAE,WAAW;QAAM,GAC/B,KAAK,CAAC,GACN,WAAW;QAEd,qCAAqC;QACrC,MAAM,EAAE,MAAM,MAAM,EAAE,GAAG,MAAM,SAC5B,IAAI,CAAC,wBACL,MAAM,CAAC,wCACP,KAAK,CAAC,MAAM;YAAE,WAAW;QAAM,GAC/B,KAAK,CAAC;QAET,kCAAkC;QAClC,MAAM,EAAE,MAAM,KAAK,EAAE,GAAG,MAAM,SAC3B,IAAI,CAAC,oBACL,MAAM,CAAC,KACP,EAAE,CAAC,MAAM,GACT,WAAW;QAEd,MAAM,SAAS,CAAC;;;;;;AAMpB,EAAE,KAAK,SAAS,CAAC,cAAc,eAAe,CAAC,GAAG,MAAM,GAAG;;;AAG3D,EAAE,KAAK,SAAS,CAAC,UAAU,EAAE,EAAE,MAAM,GAAG;;;AAGxC,EAAE,KAAK,SAAS,CAAC,SAAS,CAAC,GAAG,MAAM,GAAG;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA+BvC,CAAC;QAEG,MAAM,IAAI,MAAM,MAAM,eAAe,CAAC;QACtC,MAAM,OAAO,EAAE,QAAQ,CAAC,IAAI;QAC5B,MAAM,OAAO,YAAY;QAEzB,IAAI,CAAC,MACH,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;YAA2B,KAAK;QAAK,GAC9C;YAAE,QAAQ;QAAI;QAGlB,sBAAsB;QACtB,MAAM,SACH,IAAI,CAAC,oBACL,MAAM,CACL;YACE,IAAI;YACJ,cAAc;YACd,YAAY,KAAK,OAAO;YACxB,YAAY,IAAI,OAAO,WAAW;QACpC,GACA;YAAE,YAAY;QAAK;QAGvB,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,OAAO;YACP,KAAK;QACP;IACF,EAAE,OAAO,KAAU;QACjB,QAAQ,KAAK,CAAC,uBAAuB;QACrC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO,IAAI,OAAO;QAAC,GAAG;YAAE,QAAQ;QAAI;IACjE;AACF","debugId":null}}]
}