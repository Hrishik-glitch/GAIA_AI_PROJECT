{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///D:/Projects/GAIA_AI_PROJECT/app/api/symbiosphere/report/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport { GoogleGenerativeAI } from \"@google/generative-ai\";\r\nimport { createClient } from \"@supabase/supabase-js\";\r\n\r\nconst genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY!);\r\nconst model = genAI.getGenerativeModel({ model: \"gemini-2.0-flash-lite\" });\r\n\r\nconst supabase = createClient(\r\n  process.env.SUPABASE_URL!,\r\n  process.env.SUPABASE_ANON!\r\n);\r\n\r\n// Extract JSON embedded in mixed Gemini text\r\nfunction extractJson(text: string) {\r\n  const match = text.match(/\\{[\\s\\S]*\\}/);\r\n  if (!match) return null;\r\n  try {\r\n    return JSON.parse(match[0]);\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\nexport async function POST(req: Request) {\r\n  try {\r\n    const body = await req.json();\r\n\r\n    const { category, location, level, note, photo } = body;\r\n\r\n    const prompt = `\r\nYou are GAIA 2.0 â€” a planetary-scale cognitive system.\r\n\r\nA new **SymbioSphere environmental report** has arrived.\r\n\r\n--- RAW REPORT ---\r\nCategory: ${category}\r\nLevel: ${level}\r\nLocation: ${location}\r\nUser Notes: ${note || \"none\"}\r\nPhoto Attached: ${photo ? \"YES\" : \"NO\"}\r\n------------------\r\n\r\nAnalyze this report deeply and produce:\r\n\r\nANALYSIS:\r\nFree GAIA reasoning (ecology, atmospheric chemistry, ecosystems).\r\n\r\nJSON:\r\n{\r\n  \"pollution_risk\": Number(0-1),\r\n  \"biodiversity_change\": Number(-1 to 1),\r\n  \"water_quality_shift\": Number(-1 to 1),\r\n  \"heat_stress\": Number(0-1),\r\n\r\n  \"summary\": \"short readable explanation\",\r\n  \"recommended_interventions\": [\"...\", \"...\"]\r\n}\r\n`;\r\n\r\n    const result = await model.generateContent(prompt);\r\n    const text = result.response.text();\r\n\r\n    const json = extractJson(text);\r\n\r\n    if (!json) {\r\n      return NextResponse.json(\r\n        { error: \"Gemini returned no valid JSON\", raw: text },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    // Store full report\r\n    await supabase.from(\"symbiosphere_reports\").insert([\r\n      {\r\n        category,\r\n        location,\r\n        level,\r\n        note,\r\n        image_base64: photo || null,\r\n        ai_analysis: text.slice(0, 8000),\r\n        ai_json: json\r\n      }\r\n    ]);\r\n\r\n    // Update global GAIA state\r\n    await supabase\r\n      .from(\"gaia_state_cache\")\r\n      .upsert(\r\n        {\r\n          id: 1,\r\n          last_event: \"symbiosphere_update\",\r\n          symbio_analysis: json,\r\n          updated_at: new Date().toISOString()\r\n        },\r\n        { onConflict: \"id\" }\r\n      );\r\n\r\n    return NextResponse.json({\r\n      message: \"Report processed successfully\",\r\n      analysis: text,\r\n      extracted: json\r\n    });\r\n  } catch (err: any) {\r\n    console.error(\"ðŸ”¥ SymbioSphere error:\", err);\r\n    return NextResponse.json({ error: err.message }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAEA,MAAM,QAAQ,IAAI,sLAAkB,CAAC,QAAQ,GAAG,CAAC,cAAc;AAC/D,MAAM,QAAQ,MAAM,kBAAkB,CAAC;IAAE,OAAO;AAAwB;AAExE,MAAM,WAAW,IAAA,yMAAY,EAC3B,QAAQ,GAAG,CAAC,YAAY,EACxB,QAAQ,GAAG,CAAC,aAAa;AAG3B,6CAA6C;AAC7C,SAAS,YAAY,IAAY;IAC/B,MAAM,QAAQ,KAAK,KAAK,CAAC;IACzB,IAAI,CAAC,OAAO,OAAO;IACnB,IAAI;QACF,OAAO,KAAK,KAAK,CAAC,KAAK,CAAC,EAAE;IAC5B,EAAE,OAAM;QACN,OAAO;IACT;AACF;AAEO,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,MAAM,OAAO,MAAM,IAAI,IAAI;QAE3B,MAAM,EAAE,QAAQ,EAAE,QAAQ,EAAE,KAAK,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG;QAEnD,MAAM,SAAS,CAAC;;;;;;UAMV,EAAE,SAAS;OACd,EAAE,MAAM;UACL,EAAE,SAAS;YACT,EAAE,QAAQ,OAAO;gBACb,EAAE,QAAQ,QAAQ,KAAK;;;;;;;;;;;;;;;;;;AAkBvC,CAAC;QAEG,MAAM,SAAS,MAAM,MAAM,eAAe,CAAC;QAC3C,MAAM,OAAO,OAAO,QAAQ,CAAC,IAAI;QAEjC,MAAM,OAAO,YAAY;QAEzB,IAAI,CAAC,MAAM;YACT,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;gBAAiC,KAAK;YAAK,GACpD;gBAAE,QAAQ;YAAI;QAElB;QAEA,oBAAoB;QACpB,MAAM,SAAS,IAAI,CAAC,wBAAwB,MAAM,CAAC;YACjD;gBACE;gBACA;gBACA;gBACA;gBACA,cAAc,SAAS;gBACvB,aAAa,KAAK,KAAK,CAAC,GAAG;gBAC3B,SAAS;YACX;SACD;QAED,2BAA2B;QAC3B,MAAM,SACH,IAAI,CAAC,oBACL,MAAM,CACL;YACE,IAAI;YACJ,YAAY;YACZ,iBAAiB;YACjB,YAAY,IAAI,OAAO,WAAW;QACpC,GACA;YAAE,YAAY;QAAK;QAGvB,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,UAAU;YACV,WAAW;QACb;IACF,EAAE,OAAO,KAAU;QACjB,QAAQ,KAAK,CAAC,0BAA0B;QACxC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO,IAAI,OAAO;QAAC,GAAG;YAAE,QAAQ;QAAI;IACjE;AACF","debugId":null}}]
}